<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Randevu Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            background-color: #f4f7fc;
            font-family: 'Arial', sans-serif;
        }
        .navbar {
            background: linear-gradient(90deg, #007bff, #6610f2);
        }
        .navbar-brand {
            font-weight: bold;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white !important;
            border-radius: 5px;
        }
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(90deg, #007bff, #6610f2);
            border: none;
        }
        .tab-pane {
            animation: fadeIn 0.5s ease;
        }
        .welcome-msg {
            font-size: 1.5rem;
            font-weight: 600;
            color: #5d5d5d;
        }
        .user-info {
            font-size: 1rem;
            color: #6c757d;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        /* Bildirim Stili */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
        }
        .notification button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 10px;
        }

    </style>
</head>
<body>
<a class="navbar-brand" href="#" style="background-color: #343a40; padding: 10px 15px; border-radius: 5px;">
    <span style="font-size: 1.8rem; font-weight: bold; color: #fff; letter-spacing: 2px;">MR&CT</span>
    <span style="font-size: 1rem; font-weight: 400; color: #ddd;"> Randevu Merkezi</span>
</a>

<div class="container mt-5">
    <h1 class="text-center mb-4">Randevu Yönetim Paneli</h1>
    <input type="hidden" id="userId" value="${userId}" />
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
        <span class="welcome-msg" style="font-size: 1.5rem; font-weight: 600; color: #007bff;">
            Hoş geldiniz,
            <strong style="font-size: 1.8rem; color: #6610f2;">
                <span>
                    <span th:switch="${userType}">
                        <span th:case="'PATIENT'" style="color: #17a2b8; font-style: italic;">
                            Hasta
                        </span>
                        <span th:case="'DOCTOR'" style="color: #17a2b8; font-style: italic;">
                            Dr.
                        </span>
                        <span th:case="'ADMIN'" style="color: #17a2b8; font-style: italic;">
                            Admin
                        </span>
                    </span>
                    <span th:text="' ' + ${username}"></span>
                </span>
            </strong>
        </span>

        </div>
        <div class="d-flex align-items-center">
            <!-- Yeni Sekmeler -->
            <button class="btn btn-secondary me-2" id="btnDoctorCalendar" style="display: none;" onclick="navigateTo('/doctor-calendar')">Randevu Takvimi</button>
            <button class="btn btn-warning me-2" id="btnAdminPanel" style="display: none;" onclick="navigateTo('/admin-panel')">Admin Paneli</button>
            <!-- Çıkış Yap -->
            <button class="btn btn-danger" onclick="logout()">Çıkış Yap</button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="appointmentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-home" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Randevu Al</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-appointments" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab" aria-controls="appointments" aria-selected="false">Randevularım</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-profile" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Profilim</button>
        </li>
    </ul>

    <div class="tab-content" id="appointmentTabsContent">
        <!-- Randevu Al Sekmesi -->
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="tab-home">
            <form id="appointmentForm">
                <div class="mb-3">
                    <label for="specialty" class="form-label">Alan Seçimi</label>
                    <select class="form-select" id="specialty" name="specialty" onchange="loadDoctors()">
                        <option value="" disabled selected>Alan seçiniz</option>
                        <option value="Dahiliye">Dahiliye</option>
                        <option value="Kardiyoloji">Kardiyoloji</option>
                        <option value="Ortopedi">Ortopedi</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="doctor" class="form-label">Doktor Seçimi</label>
                    <select class="form-select" id="doctor" name="doctor" onchange="loadSchedule()" disabled>
                        <option value="" disabled selected>Doktor seçiniz</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="appointmentDate" class="form-label">Randevu Tarihi</label>
                    <input type="date" class="form-control" id="appointmentDate" name="appointmentDate">
                </div>
                <div class="mb-3">
                    <label for="schedule" class="form-label">Randevu Slotları</label>
                    <div id="schedule" class="table-responsive"></div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Randevu Al</button>
            </form>
        </div>

        <!-- Randevularım Sekmesi -->
        <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="tab-appointments">
            <h3>Randevularım</h3>
            <p>Henüz bir randevunuz bulunmamaktadır.</p>
        </div>

        <!-- Profilim Sekmesi -->
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="tab-profile">
            <h3>Profilim</h3>
            <p>Bu sekmede kullanıcı bilgilerinizi görüntüleyebilirsiniz.</p>
        </div>
    </div>
</div>

<!-- Bildirim Alanı -->
<div id="notification" class="notification">
    <button onclick="closeNotification()">×</button>
    <span id="notificationMessage"></span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        const datePicker = document.getElementById('appointmentDate');
        datePicker.value = today;
        datePicker.dispatchEvent(new Event('change')); // Slotları otomatik yükle

        const userType = "[[${userType}]]"; // Thymeleaf değişkeni ile backend'den alınır
        const btnDoctorCalendar = document.getElementById('btnDoctorCalendar');
        const btnAdminPanel = document.getElementById('btnAdminPanel');

        // Kullanıcı türüne göre butonları göster
        if (userType === 'ADMIN') {
            btnAdminPanel.style.display = 'inline-block';
        }
        if (userType === 'DOCTOR') {
            btnDoctorCalendar.style.display = 'inline-block';
        }
    });

    function navigateTo(url) {
        window.location.href = url; // Verilen URL'ye yönlendirir
    }

    async function loadDoctors() {
        const specialty = document.getElementById('specialty').value;
        const doctorSelect = document.getElementById('doctor');
        doctorSelect.disabled = true;

        try {
            const response = await axios.get(`/doctors?specialty=${specialty}`);
            doctorSelect.innerHTML = '<option value="" disabled selected>Doktor seçiniz</option>';
            response.data.forEach(doctor => {
                doctorSelect.innerHTML += `<option value="${doctor.id}">${doctor.doctorDetail.specialty} - Dr. ${doctor.username}</option>`;
            });
            doctorSelect.disabled = false;
        } catch (error) {
            console.error('Doktorlar yüklenirken hata:', error);
        }
    }

    document.getElementById('appointmentDate').addEventListener('change', loadSchedule);

    async function loadSchedule() {
        const doctorId = document.getElementById('doctor').value;
        const appointmentDate = document.getElementById('appointmentDate').value;
        const scheduleDiv = document.getElementById('schedule');
        if (!doctorId || !appointmentDate) return;

        scheduleDiv.innerHTML = '<p>Yükleniyor...</p>';

        try {
            const response = await axios.get(`/appointment?doctorId=${doctorId}&date=${appointmentDate}`);
            const slots = response.data;

            if (slots.length > 0) {
                let html = '<table class="table"><thead><tr><th>Saat</th><th>Durum</th><th>Seçim</th></tr></thead><tbody>';
                slots.forEach(slot => {
                    const formattedTime = slot.time.slice(0, 5);
                    html += `
                    <tr>
                        <td>${formattedTime}</td>
                        <td>${slot.available ? '<span class="text-success">Müsait</span>' : '<span class="text-danger">Dolu</span>'}</td>
                        <td>${slot.available ? `<button class="btn btn-success btn-sm" onclick="selectSlot('${slot.date}', '${slot.time}', this)">Seç</button>` : ''}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                scheduleDiv.innerHTML = html;
            } else {
                scheduleDiv.innerHTML = '<p class="text-muted">Müsait randevu bulunamadı.</p>';
            }
        } catch (error) {
            console.error('Randevu slotları yüklenirken hata:', error);
        }
    }

    let selectedSlot = null;
    let previousButton = null;  // Önceki butonu saklamak için bir değişken ekledik.

    function selectSlot(date, time, button) {
        // Eğer daha önce bir slot seçildiyse, önceki butonu eski haline getir
        if (previousButton) {
            previousButton.innerHTML = "Seç";
            previousButton.disabled = false;
        }

        // Şimdi yeni seçilen slotu işaretle
        selectedSlot = { date, time };
        button.innerHTML = "Seçildi";  // Buton metnini "Seçildi" yap
        button.disabled = true;  // Butonu devre dışı bırak

        // Yeni butonu önceki buton olarak sakla
        previousButton = button;
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        document.getElementById('notificationMessage').textContent = message;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 10000); // 10 saniye sonra kapanır
    }

    function closeNotification() {
        const notification = document.getElementById('notification');
        notification.style.display = 'none';
    }


    document.getElementById('appointmentForm').addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent form submission
        if (!selectedSlot) {
            alert("Lütfen bir randevu slotu seçiniz!");
            return;
        }

        const userId = "[[${userId}]]"

        try {
            const response = await axios.post('/appointment/reserve', {
                userId: userId,
                doctorId: document.getElementById('doctor').value,
                date: selectedSlot.date,
                time: selectedSlot.time
            });

            // Yanıt verisini al
            const reservationCode = response.data.reservationCode;

            // Bildirimi göster
            showNotification(`Randevunuz başarıyla alındı. Rezervasyon Kodu: ${reservationCode}`);
            loadSchedule();
        } catch (error) {
            // Hata durumunda bildirim göster
            showNotification('Randevu alınırken bir hata oluştu.');
            console.error(error);
        }
    });

    function logout() {
        window.location.href = '/logout';
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
