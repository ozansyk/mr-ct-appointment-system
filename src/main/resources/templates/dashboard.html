<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Randevu Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(90deg, #007bff, #6610f2);
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white !important;
            border-radius: 5px;
        }
        .tab-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(90deg, #007bff, #6610f2);
            border: none;
        }
        .tab-pane {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Randevu Sistemi</a>
        <button class="btn btn-danger ms-auto" onclick="logout()">Çıkış Yap</button>
    </div>
</nav>

<div class="container mt-5">
    <h1 class="text-center mb-4">Randevu Yönetim Paneli</h1>

    <ul class="nav nav-tabs mb-3" id="appointmentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-home" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Randevu Al</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-appointments" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab" aria-controls="appointments" aria-selected="false">Randevularım</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-profile" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Profilim</button>
        </li>
    </ul>

    <div class="tab-content" id="appointmentTabsContent">
        <!-- Randevu Al Sekmesi -->
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="tab-home">
            <form id="appointmentForm">
                <div class="mb-3">
                    <label for="specialty" class="form-label">Alan Seçimi</label>
                    <select class="form-select" id="specialty" name="specialty" onchange="loadDoctors()">
                        <option value="" disabled selected>Alan seçiniz</option>
                        <option value="Dahiliye">Dahiliye</option>
                        <option value="Kardiyoloji">Kardiyoloji</option>
                        <option value="Ortopedi">Ortopedi</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="doctor" class="form-label">Doktor Seçimi</label>
                    <select class="form-select" id="doctor" name="doctor" onchange="loadSchedule()" disabled>
                        <option value="" disabled selected>Doktor seçiniz</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="appointmentDate" class="form-label">Randevu Tarihi</label>
                    <input type="date" class="form-control" id="appointmentDate" name="appointmentDate">
                </div>
                <div class="mb-3">
                    <label for="schedule" class="form-label">Randevu Slotları</label>
                    <div id="schedule" class="table-responsive"></div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Randevu Al</button>
            </form>
        </div>

        <!-- Randevularım Sekmesi -->
        <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="tab-appointments">
            <h3>Randevularım</h3>
            <p>Henüz bir randevunuz bulunmamaktadır.</p>
        </div>

        <!-- Profilim Sekmesi -->
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="tab-profile">
            <h3>Profilim</h3>
            <p>Bu sekmede kullanıcı bilgilerinizi görüntüleyebilirsiniz.</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        const datePicker = document.getElementById('appointmentDate');
        datePicker.value = today;
        datePicker.dispatchEvent(new Event('change')); // Slotları otomatik yükle
    });

    async function loadDoctors() {
        const specialty = document.getElementById('specialty').value;
        const doctorSelect = document.getElementById('doctor');
        doctorSelect.disabled = true;

        try {
            const response = await axios.get(`/doctors?specialty=${specialty}`);
            doctorSelect.innerHTML = '<option value="" disabled selected>Doktor seçiniz</option>';
            response.data.forEach(doctor => {
                doctorSelect.innerHTML += `<option value="${doctor.id}">${doctor.doctorDetail.specialty} - Dr. ${doctor.username}</option>`;
            });
            doctorSelect.disabled = false;
        } catch (error) {
            console.error('Doktorlar yüklenirken hata:', error);
        }
    }

    document.getElementById('appointmentDate').addEventListener('change', loadSchedule);

    async function loadSchedule() {
        const doctorId = document.getElementById('doctor').value;
        const appointmentDate = document.getElementById('appointmentDate').value;
        const scheduleDiv = document.getElementById('schedule');
        if (!doctorId || !appointmentDate) return;

        scheduleDiv.innerHTML = '<p>Yükleniyor...</p>';

        try {
            const response = await axios.get(`/appointment?doctorId=${doctorId}&date=${appointmentDate}`);
            const slots = response.data;

            if (slots.length > 0) {
                let html = '<table class="table"><thead><tr><th>Saat</th><th>Durum</th><th>Seçim</th></tr></thead><tbody>';
                slots.forEach(slot => {
                    const formattedTime = slot.time.slice(0, 5);
                    html += `
                    <tr>
                        <td>${formattedTime}</td>
                        <td>${slot.available ? '<span class="text-success">Müsait</span>' : '<span class="text-danger">Dolu</span>'}</td>
                        <td>${slot.available ? `<button class="btn btn-success btn-sm" onclick="selectSlot('${slot.date}', '${slot.time}')">Seç</button>` : ''}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                scheduleDiv.innerHTML = html;
            } else {
                scheduleDiv.innerHTML = '<p class="text-muted">Müsait randevu bulunamadı.</p>';
            }
        } catch (error) {
            console.error('Randevu slotları yüklenirken hata:', error);
        }
    }


    let selectedSlot = {};

    function selectSlot(date, time) {
        selectedSlot = { date, time };
        alert(`Seçilen Randevu: ${date} - ${time}`);
    }

    document.getElementById('appointmentForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!selectedSlot.date || !selectedSlot.time) {
            alert("Lütfen bir randevu slotu seçiniz!");
            return;
        }

        try {
            const response = await axios.post('/appointment/book', {
                doctorId: document.getElementById('doctor').value,
                date: selectedSlot.date,
                time: selectedSlot.time
            });
            alert(`Randevu başarıyla alındı! Rezervasyon Kodu: ${response.data.code}`);
        } catch (error) {
            console.error("Randevu alınırken hata:", error);
            alert("Randevu alınamadı, lütfen tekrar deneyin.");
        }
    });


    function logout() {
        window.location.href = '/logout';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
